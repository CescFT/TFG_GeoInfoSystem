<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Crear nou punt</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
    <style>
        /* Style the header with a grey background and some padding */
    .header {
      overflow: hidden;
      background-color: #f1f1f1;
      padding: 20px 10px;
    }

    /* Style the header links */
    .header a {
      float: left;
      color: black;
      text-align: center;
      padding: 12px;
      text-decoration: none;
      font-size: 18px;
      line-height: 25px;
      border-radius: 4px;
    }

    /* Style the logo link (notice that we set the same value of line-height and font-size to prevent the header to increase when the font gets bigger */
    .header a.logo {
      font-size: 25px;
      font-weight: bold;
    }

    /* Change the background color on mouse-over */
    .header a:hover {
      background-color: #ddd;
      color: black;
    }

    /* Style the active/current link*/
    .header a.active {
      background-color: dodgerblue;
      color: white;
    }

    /* Float the link section to the right */
    .header-right {
      float: right;
    }

    /* Add media queries for responsiveness - when the screen is 500px wide or less, stack the links on top of each other */
    @media screen and (max-width: 500px) {
      .header a {
        float: none;
        display: block;
        text-align: left;
      }
      .header-right {
        float: none;
      }
    }
    #map {
        height: 400px;  /* The height is 400 pixels */
        width: 100%;  /* The width is the width of the web page */
       }
        .checked{
            color:gold;
        }
        .unchecked{
            color: black;
        }

    </style>

</head>
<body onload="inicialitzacioAfegirNouPunt()">
    <div class="header">
        <a href="/" class="logo active"><i class="fa fa-home" aria-hidden="true"></i> Sistema d'Informació Geogràfica</a>
        <div class="header-right">
            <a href="/v1/geoInfoSystem/map/"><i class="fa fa-globe" aria-hidden="true"></i> Visualitza el mapa</a>
            {% if user.is_authenticated %}
                <a href="/v1/geoInfoSystem/el_meu_espai/"><i class="fa fa-user"></i> {{ user.username }}</a>
                <a href="/v1/geoInfoSystem/tancar_sessio/"><i class="fa fa-sign-out"></i> Tanca la sessió</a>
            {% else %}
                <a href="/v1/geoInfoSystem/registrar_nou_usuari/"><i class="fa fa-sign-in"></i> Registra't</a>
                <a href="/v1/geoInfoSystem/inicia_sessio/"><i class="fa fa-check"></i> Inicia sessió</a>
            {% endif %}
        </div>
    </div>
    <br>
    <h1 class="text-center">Sistema GIS - Nous punts</h1>
    <hr>

    <!--FAQS I INSTRUCCIONS-->

    <div class="container">
        <div class="btn-group" role="group">
            <button class="btn btn-secondary" type="button" onclick="displayInstructions()"><img style="height: 22px" src="https://img.icons8.com/dotty/80/000000/user-manual.png"/> Instruccions</button>
            <button class="btn btn-secondary" type="button" onclick="displayFAQS()"><img  style="height: 22px" src="https://img.icons8.com/ios-glyphs/64/000000/thinking-male.png"/> Preguntes freqüents</button>
        </div>
    </div>
    <br>
    <div class="container">
        <div class="row">
            <div id="instruccions" class="estilguai" hidden>
                <div id="instruccionscard" class="container">
                    <div class="card card-body">
                        <h2><img height="70px" src="https://img.icons8.com/dotty/80/000000/user-manual.png"/> Instruccions</h2>
                            <div class="row">
                                <ol>
                                    <li><b>Mapa</b>: El mapa et serveix per a apretar els punts d'interès que vulguis afegir en el sistema GIS.
                                    </li>
                                    <li><b>Botonera</b>:
                                        <ul>
                                            <li><b><i>Centrar mapa</i></b>: Amb aquesta funció podràs centrar el mapa aproximant la posició en la que et trobes. Has de donar permís al navegador per a poder fer ús d'aquesta tecnologia.</li>
                                            <li><b><i>Esborrar els punts marcats</i></b>: Amb aquesta funció, quan hi hagi els punts marcats en el mapa, podràs eliminar-los tots de cop.</li>
                                            <li><b><i>Mostrar punts</i></b>: Un cop hagis marcat punts en el mapa i apretis el botó, passaràs a la <i>següent fase</i>:
                                                <ul>
                                                    <li>
                                                        Es mostrarà un desplegable amb tots els punts nous. Els noms dels punts en el desplegable tenen la forma: <b>Punt <i>X</i></b>, on X=1 és el primer punt apretat en el mapa i X=N, l'últim punt d'interès marcat.
                                                    </li>
                                                    <li>
                                                        Es selecciona un dels punts que hi ha en el desplegable i s'apreta el botó "Següent". Quan apretem aquest, el sistema mostrarà un formulari per tal de completar tota la informació necessària per a documentar el local.
                                                    </li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                 </ol>
                            </div>
                    </div>
                    <br>
                </div>
            </div>
        </div>
        <div class="row">
            <div id="faqsBO" hidden>
                <div class="container" id="faqs">
                    <div class="card card-body">
                        <h2><img  style="height: 70px" src="https://img.icons8.com/ios-glyphs/64/000000/thinking-male.png"/> Preguntes freqüents</h2>
                        <div class="row">
                            <ol>
                                <li id="errorcomu">
                                    <b>He rebut l'avís "<i class="fa fa-exclamation-triangle"></i> Error al processar. Revisa les preguntes freqüents". Què ha passat?</b>
                                    <p style="margin-left: 10px;" align="justify">Tranquil, no et preucupis. El més comú és passa és que s'intenti posar un punt d'interès nou amb una categoria i ciutat existents. El sistema GIS, abans de processar els punts, comprova que no es posi un nou punt ja existent, és a dir, un punt en una ciutat i amb una categoria iguals.
                                    Per tant, només es poden posar punts nous que no existeixin prèviament en el sistema GIS.
                                    </p>
                                    <b>Ho he posat bé i m'ha aparegut aquest error, que faig?</b>
                                    <p style="margin-left: 10px" align="justify">En cas de fer bé això, comprova sempre que els camps "<i>Superficie</i>" i "<i>any de construcció</i>" siguin numèrics i coherents. En altre cas, no et permetrà.</p>
                                </li>
                                <li><b>Puc centrar el mapa si no permeto la geolocalització del navegador en aquest lloc web?</b>
                                    <p style="margin-left: 10px" align="justify">Malauradament no. Aquesta opció funciona gràcies a un mecanisme que hi ha incorporat en la versió 5 del llenguatge HTML, de l'Anglès <i>HyperText Markup Language</i>.</p>
                                    <b>I si no centro el mapa no puc afegir nou/s punt/s d'interès nou/s?</b>
                                    <p style="margin-left: 10px" align="justify">El fet de no acceptar la geolocalització no impedirà en cap cas que el sistema GIS pugui afegir el nou o nous punts. Simplement és una ajuda per tu, per centrar el mapa en la localitat on estàs.</p>
                                </li>
                                <li><b>He marcat un punt i vull marcar un altre quan ja tinc el desplegable de punts d'interès nous obert. Què haig de fer per a actualitzar el llistat de punts per a processar?</b>
                                    <br>
                                    <p style="margin-left: 10px;" align="justify">El botó que abans permetia mostrar els punts, ara permet l'actualització del llistat de punts del desplegable.
                                        <br>Amb aquesta opció podràs actualitzar el desplegable i podràs processar els nous punts que hagis posat en aquest cas.</p>
                                    <b>I llavors, com puc tancar el desplegable?</b>
                                    <p style="margin-left: 10px;" align="justify">El desplegable el podràs tancar perquè apareix un nou botó que té aquesta opció.</p>
                                </li>
                                <li>
                                    <b>Què passa si intento mostrar punts marcats quan no hi ha cap punt en el mapa?</b>
                                    <p style="margin-left: 10px" align="justify">Tranquil, no passa res. Simplement la web t'avisa de que no tens cap punt marcat i et convida a que posis els punts nous en el mapa.</p>
                                </li>
                                <li>
                                    <b>Puc afegir un nou punt si no omplo el formulari de la informació referent al local?</b>
                                    <p style="margin-left: 10px;" align="justify">No. El sistema et retornarà de nou a la pàgina aquesta, guardant tots els punts que hagis posat en el mapa i hauràs de repetir
                                        totes les accions que s'expliquen en l'apartat de les <a href="#instruccionscard">instruccions</a>.</p>
                                    <b>Això vol dir que en cas d'error al processar la informació, retornaré aquí amb totes les dades guardades?</b>
                                    <p style="margin-left: 10px" align="justify">Exacte. Sempre que hi hagi algun error referent amb el formulari final, on es demana la informació del local.</p>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
      </div>
    </div>
    <div class="container">
            <h2><img src="https://img.icons8.com/ios-glyphs/100/000000/map-marker.png"/>Afegeix punts al sistema GIS</h2>
            <div class="col-xs-12 col-md-8" style="float:none; margin:auto;"> <!--col-xs-12 col-md-8-->
                <div id="mapid" style="height: 400px"></div>
                <div class="text-center">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary" onclick="mostraLesCoordenadesUsuari()"><img style="height: 20px" src="https://img.icons8.com/ios-glyphs/30/000000/centre-of-gravity.png"/> Centrar mapa</button>
                        <button class="btn btn-outline-secondary" onclick="eliminarTotsPuntsInteresNous()" id="boto_eliminarPunts"><i class="fa fa-eraser"></i> Esborrar els punts marcats</button>
                        <button class="btn btn-outline-secondary" onclick="mostrarCoordenades()" id="boto_mostrarDades"><i class="fa fa-eye"></i> Mostra els punts</button>
                    </div>
                </div>
                <div><p class="text-center" style="color: red" id="InformatiuNoPunts"></p></div>
                <div class="container">
                    <div id="nousPunts" style="float:none; margin:auto;" hidden>
                        <div class="row">
                            <div class="col-sm">
                                <label for="puntsNous" class="font-weight-bold">Triar punt...</label>
                            </div>
                            <div class="col-sm">
                                <select id="puntsNous" name="punts" class="form-control"></select>
                            </div>
                        </div>
                        <div style="margin-left: 15px">
                            <div class="btn-group" role="group">
                                <div class="row">
                                    <button class="btn btn-outline-danger" onclick="tancarSeleccio()" id="bttn_close"><i class="fa fa-times" aria-hidden="true"></i> Tanca selecció de punts</button>
                                    <button class="btn btn-outline-success" onclick="dadesSeguents()" id="bttn_form_data_local"><i class="fa fa-arrow-right"></i> Següent</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <br>
            <div id="dadesSeguents" hidden>
                <div class="row form-row">
                        <div style="float:none; margin:auto" class="card card-body">
                            <div id="errorsBuits" class="text-center" style="color:red" hidden></div>
                            <div id="errorsProcessament" class="text-center" style="color:red" hidden><b><i class="fa fa-exclamation-triangle"></i> Error al processar. Revisa les <a class="text-danger" href="#errorcomu">preguntes freqüents</a></b></div>
                            <br>
                            <div class="form-group">
                                <form id="form_guardar_nou_punt" onsubmit="return checkValues()" method="POST" action="/v1/geoInfoSystem/nouPunt/" enctype="multipart/form-data">
                                    {%csrf_token%}
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-sm">
                                                <label class="font-weight-bold">Nom del local</label>
                                            </div>
                                            <div class="col-sm">
                                                <input type="text" name="nomLocal" id="nomLocal" placeholder="Ex: Bar El Sindicat" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <textarea class="form-control" rows="3" name="descripcioLocal" id="descripcio" placeholder="Breu descripció del lloc."></textarea>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-sm">
                                                <label class="font-weight-bold">Tipus</label>
                                            </div>
                                            <div class="col-sm">
                                                <div id="tipusPunt"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-sm">
                                                <label class="font-weight-bold">Superficie</label>
                                            </div>
                                            <div class="col-sm">
                                                <input type="text" name="superficie" id="superficie" placeholder="Ex: 25.45 m2" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-sm">
                                                <label class="font-weight-bold">Província</label>
                                            </div>
                                            <div class="col-sm-6">
                                                <div id="selectProvincia">Selecciona la provincia:</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-sm">
                                                <label class="font-weight-bold">Localitat</label>
                                            </div>
                                            <div class="col-sm">
                                                <div id="ubicacio"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-sm">
                                                <label class="form-weight-bold"><b>Estat de Conservació</b></label>
                                            </div>
                                            <div class="col-sm">
                                                <div class="estrelles">
                                                    <i class="fa fa-star unchecked" id="1"></i>
                                                    <i class="fa fa-star unchecked" id="2"></i>
                                                    <i class="fa fa-star unchecked" id="3"></i>
                                                    <i class="fa fa-star unchecked" id="4"></i>
                                                    <i class="fa fa-star unchecked" id="5"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-sm">
                                                <label class="font-weight-bold">Any de construcció</label>
                                            </div>
                                            <div class="col-sm">
                                                <input type="text" name="any" id="any" placeholder="Ex: 1714" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-sm">
                                                <label class="font-weight-bold">Fotografia del local</label>
                                            </div>
                                            <div class="col-sm">
                                                <input type="file" accept="image/*" name="image"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <div class="form-check">
                                            <label class="font-weight-bold">Actiu </label>
                                            <input type="checkbox" onclick="canviEstat()" name="actiu" id="esActiu">
                                        </div>
                                    </div>
                                    <input type="hidden" name="llocActiu" id="botoActiu" value="False">
                                    <input type="hidden" name="p" id="puntuacio" value="0">
                                    <input type="hidden" name="tipus" id="categoriaPunt" value="Restauració"> <!--canviar per la primera categoria quan tingui les bones categories perq ara nse-->
                                    <input type="hidden" name="poblacio" id="poblacioG" value="Aiguamúrcia (Alt Camp), Tarragona">
                                    <input type="hidden" name="puntPerProcessar1" id="puntNou" value="a">
                                    <input type="hidden" name="puntprocessarAux" id="puntAux" value="">
                                    <input type="hidden" name="altresPunts" id="altresPunsNous" value="">
                                    <input type="hidden" name="midaLlista" id="midaLlistatPunts" value="">
                                </form>
                                <div class="text-center"><button style="margin:0px auto;" onclick="checkInputs()" class="btn btn-success"><i class="fa fa-plus" aria-hidden="true"></i> Desar</button></div> <!--onclick="guardarSeleccionat()"-->
                            </div>
                        </div>
                </div>
            </div>
    </div>
    <br>
    <br>
<script>
    var mymap;
    var llistatNousMarkers=[];
    var llistatTitolsNousMarkers=[];
    var llistaPuntsPendents = JSON.parse(`{{punts | safe}}`);

function inicialitzacioAfegirNouPunt() {
    var llistaPuntsPerPosar=[];
    mymap = L.map('mapid').setView([41.8204600, 1.8676800], 7);
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiY2VzY2Z0IiwiYSI6ImNrOTA0OWlxYTAxd2czdHFkMWt2eDVjN20ifQ.ORNTQ7oImBoHmaGJ_jGYvg', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: 'pk.eyJ1IjoiY2VzY2Z0IiwiYSI6ImNrOTA0OWlxYTAxd2czdHFkMWt2eDVjN20ifQ.ORNTQ7oImBoHmaGJ_jGYvg'
    }).addTo(mymap);

    if (llistaPuntsPendents.length !== 0){
        var midaLlista = `{{ lenLlista }}`;
        for(var j=0; j< llistaPuntsPendents.length; j++){
            for (var i = 0, keys = Object.keys(llistaPuntsPendents[j]), ii = keys.length; i < ii; i++) {
                let nomPunt = llistaPuntsPendents[j][keys[i]].split(",")[0];
                if(nomPunt !== "--- Siusplau selecciona un punt ---"){
                    let coordenades = llistaPuntsPendents[j][keys[i]].split(",")[1];
                    let coordenadesT = coordenades.split(" ");
                    let latitud = coordenadesT[0];
                    let longitud = coordenadesT[1];
                    llistaPuntsPerPosar.push({
                        "infoPunt": nomPunt,
                        "latitudS" : latitud,
                        "longitudS" : longitud,
                        "latitudF" : parseFloat(latitud),
                        "longitudF" : parseFloat(longitud)
                    });
                }
            }
        }
        for(var k = 0; k<llistaPuntsPerPosar.length; k++){
            let dadesAMostrar = '<div id="content">'+
            '<div id="siteNotice">'+
            '</div>'+
            '<h1>'+llistaPuntsPerPosar[k]['infoPunt']+'</h1>'+
            '<div id="bodyContent">'+
            '<p><b>'+"Latitud:"+'</b>'+llistaPuntsPerPosar[k]['latitudS']+'</p>'+
            '<p><b>'+"Longitud:"+'</b>'+llistaPuntsPerPosar[k]['longitudS']+'</p>'+
            '</div>'+
            '</div>';
            let marker = L.marker([llistaPuntsPerPosar[k]['latitudF'], llistaPuntsPerPosar[k]['longitudF']]).addTo(mymap).bindPopup(dadesAMostrar);
            llistatNousMarkers.push(marker);
            llistatTitolsNousMarkers.push({
                "titol" : llistaPuntsPerPosar[k]['infoPunt'],
                "pInteres" : marker
            });
        }

        mymap.on('click',function(event) {
            let latlng= event.latlng;
            let midaLlista = llistatNousMarkers.length;
            let marker = L.marker([latlng.lat, latlng.lng], {title:"Punt "+(midaLlista+1).toString()}).addTo(mymap);
            llistatNousMarkers.push(marker);
            llistatTitolsNousMarkers.push({
                "titol" : "Punt "+(midaLlista+1).toString(),
                "pInteres" : marker
            });
            let contentString = '<div id="content">'+
                '<div id="siteNotice">'+
                '</div>'+
                '<h1 id="firstHeading" class="firstHeading">'+llistatTitolsNousMarkers[llistatTitolsNousMarkers.length-1]['titol']+'</h1>'+
                '<div id="bodyContent">'+
                '<p><b>'+"Latitud:"+'</b>'+llistatTitolsNousMarkers[llistatTitolsNousMarkers.length-1]['pInteres'].getLatLng().lat+'</p>'+
                '<p><b>'+"Longitud:"+'</b>'+llistatTitolsNousMarkers[llistatTitolsNousMarkers.length-1]['pInteres'].getLatLng().lng+'</p>'+
                '</div>'+
                '</div>';
            marker.bindPopup(contentString);
        });
    }else{
        mymap.on('click', function(e) {
            let latlng= e.latlng;
            let midaLlista = llistatNousMarkers.length;
            let marker = L.marker([latlng.lat, latlng.lng], {title:'Punt '+(midaLlista+1).toString()}).addTo(mymap);
            console.log(marker.getLatLng());
            llistatNousMarkers.push(marker);
            llistatTitolsNousMarkers.push({
                "titol" : "Punt "+(midaLlista+1).toString(),
                "pInteres" : marker
            });
            let contentString = '<div id="content">'+
                '<div id="siteNotice">'+
                '</div>'+
                '<h1 id="firstHeading" class="firstHeading">'+llistatTitolsNousMarkers[llistatTitolsNousMarkers.length-1]['titol']+'</h1>'+
                '<div id="bodyContent">'+
                '<p><b>'+"Latitud:"+'</b>'+llistatTitolsNousMarkers[llistatTitolsNousMarkers.length-1]['pInteres'].getLatLng().lat+'</p>'+
                '<p><b>'+"Longitud:"+'</b>'+llistatTitolsNousMarkers[llistatTitolsNousMarkers.length-1]['pInteres'].getLatLng().lng+'</p>'+
                '</div>'+
                '</div>';
            marker.bindPopup(contentString);
        });
    }


}



function fade(element) {
    var op = 1;  // initial opacity
    var timer = setInterval(function () {
        if (op <= 0.1){
            clearInterval(timer);
            element.style.display = 'none';
        }
        element.style.opacity = op;
        element.style.filter = 'alpha(opacity=' + op * 100 + ")";
        op -= op * 0.1;
    }, 50);
}
function unfade(element) {
    var op = 0.1;  // initial opacity
    element.style.display = 'block';
    var timer = setInterval(function () {
        if (op >= 1){
            clearInterval(timer);
        }
        element.style.opacity = op;
        element.style.filter = 'alpha(opacity=' + op * 100 + ")";
        op += op * 0.1;
    }, 10);
}

function displayInstructions(){
    if (document.getElementById("instruccions").hidden === false){
        document.getElementById("instruccions").hidden = true;
        fade(document.getElementById("instruccions"));
    }else{
        document.getElementById("instruccions").hidden = false;
        unfade(document.getElementById("instruccions"));
    }
    document.getElementById("faqsBO").hidden = true;
    unfade(document.getElementById("faqsBO"));
}

function displayFAQS() {
    if (document.getElementById("faqsBO").hidden === false){
        document.getElementById("faqsBO").hidden = true;
        fade(document.getElementById("faqsBO"));
    }else{
        document.getElementById("faqsBO").hidden = false;
        unfade(document.getElementById("faqsBO"));
    }
    document.getElementById("instruccions").hidden = true;
    unfade(document.getElementById("instruccions"));
}

function canviEstat(){
    var checkbox = document.getElementById("esActiu");
    var actiu = document.getElementById("botoActiu");
    if(checkbox.checked == true){
        actiu.value="True";
    }else{
        actiu.value="False";
    }
}

function guardarTipus(){
    var elem = document.getElementById("tipusSeleccio");
    var inputOcult = document.getElementById("categoriaPunt");
    elem.childNodes.forEach(node => {
        if(node.selected){
            inputOcult.value=node.value;
        }
	});
}

function guardarPoblacio(){
    var elem = document.getElementById("poblacioSeleccio");
    var inputOcult = document.getElementById("poblacioG");
    elem.childNodes.forEach(node => {
        if(node.selected){
            //console.log(node.value);
            inputOcult.value = node.value;
        }
	});
}

function poblacionsPerProvincia(){
    var elem = document.getElementById("provinciaSeleccio");
    var inputOcult = document.getElementById("poblacioG");
    elem.childNodes.forEach(node => {
      if(node.selected){
            var defecte=node.value;
            $.ajax({
                type: 'GET',
                url : '/v1/geoInfoSystem/poblacions_per_provincia/',
                data:{
                    'provincia' : defecte
                },
                dataType:'json',
                success:
                    function (data){
                        var data1 = Object.values(data);
                        var pobles = Object.values(data1[0]);
                        var divpoble = document.getElementById("ubicacio");
                        divpoble.innerHTML="";
                        //console.log(pobles);
                        var sPoble = document.createElement("SELECT");
                        sPoble.setAttribute("id", "poblacioSeleccio");
                        sPoble.setAttribute("class", "form-control");
                        sPoble.setAttribute("onchange", "guardarPoblacio()");
                        divpoble.appendChild(sPoble);
                        for(var j=0; j<pobles.length; j++){
                            let option = document.createElement("option");
                            option.setAttribute("value", pobles[j]+", "+defecte);
                            let t = document.createTextNode(pobles[j]+", "+defecte);
                            option.appendChild(t);
                            document.getElementById("poblacioSeleccio").appendChild(option);
                        }
                        inputOcult.value = pobles[0]+", "+defecte;
                    }
            });
      }
    });

}

function dadesSeguents() {
    var divseleccio = document.getElementById("tipusPunt");
    divseleccio.innerHTML='';
    var divpoble = document.getElementById("ubicacio");
    divpoble.innerHTML='';
    var x = document.getElementById("dadesSeguents");
    var seleccio = document.getElementById("puntsNous");
    var malament = 1;
    var tipusDades = JSON.parse(`{{categories|safe}}`);
    var categoriesToDo =[];
    var poblacions = JSON.parse(`{{ poblacions | safe }}`);
    var poblesToDo = [];
    var provincies = JSON.parse(`{{provincies | safe}}`);
    var provinciesToDo = Object.values(provincies);
    var divprova = document.getElementById("selectProvincia");
    divprova.innerHTML='';
    //console.log(provinciesToDo);

    var sProvincia = document.createElement("SELECT");
    sProvincia.setAttribute("id", "provinciaSeleccio");
    sProvincia.setAttribute("class", "form-control");
    sProvincia.setAttribute("onchange", "poblacionsPerProvincia()");
    divprova.appendChild(sProvincia);
    for(var k=0; k<provinciesToDo.length; k++){
        let option = document.createElement("option");
        option.setAttribute("value", provinciesToDo[k]);
        let t = document.createTextNode(provinciesToDo[k]);
        option.appendChild(t);
        document.getElementById("provinciaSeleccio").appendChild(option);
    }

    for (poble of poblacions){
        poblesToDo.push({
            "ciutat":poble.fields.ciutat,
            "comarca":poble.fields.comarca,
            "provincia":poble.fields.provincia
        });
    }
    //console.log(poblesToDo);
    var sPoble = document.createElement("SELECT");
    sPoble.setAttribute("id", "poblacioSeleccio");
    sPoble.setAttribute("class", "form-control");
    sPoble.setAttribute("onchange", "guardarPoblacio()");
    divpoble.appendChild(sPoble);
    for(var j=0; j<poblesToDo.length; j++){
        let option = document.createElement("option");
        option.setAttribute("value", poblesToDo[j]['ciutat']+" ("+poblesToDo[j]['comarca']+"), "+poblesToDo[j]['provincia']);
        let t = document.createTextNode(poblesToDo[j]['ciutat']+" ("+poblesToDo[j]['comarca']+"), "+poblesToDo[j]['provincia']);
        option.appendChild(t);
        document.getElementById("poblacioSeleccio").appendChild(option);
    }

    for(tipus of tipusDades){
        categoriesToDo.push({
           "categoria":tipus.fields.categoria,
        });
    }
    //console.log(categoriesToDo);
    var select = document.createElement("SELECT");
    select.setAttribute("id", "tipusSeleccio");
    select.setAttribute("class", "form-control");
    select.setAttribute("onchange", "guardarTipus()");
    divseleccio.appendChild(select);

    for(var i=0; i<categoriesToDo.length; i++){
        let option = document.createElement("option");
        option.setAttribute("value", categoriesToDo[i]['categoria']);
        let t = document.createTextNode(categoriesToDo[i]['categoria']);
        option.appendChild(t);
        document.getElementById("tipusSeleccio").appendChild(option);
    }


    seleccio.childNodes.forEach(node => {
        if(node.selected){
            if(node.value == "selectcard"){
                alert('Selecciona un punt que vulguis afegir al sistema GIS.');
                malament = 0;
            }
        }
	});
    if (malament ===1){
        x.hidden = false;
        document.getElementById("bttn_form_data_local").disabled=true;
        var bttnTancar=document.getElementById("bttn_close");
        bttnTancar.innerHTML="<i class=\"fa fa-times\" aria-hidden=\"true\"></i> Tancar tot";
    }
}

function checkValues(){
    var input=document.getElementById("puntNou").value;
    if (input=='a')
        return false;
    else return true;

}

function tancarSeleccio() {
    var div = document.getElementById("nousPunts");
    var divForm = document.getElementById("dadesSeguents");
    var divTipus = document.getElementById("tipusPunt");
    var divProv = document.getElementById("selectProvincia");
    var divUbi = document.getElementById("ubicacio");
    divTipus.innerHTML='';
    divProv.innerHTML='';
    divUbi.innerHTML='';
    div.hidden=true;
    if(divForm.hidden == false){
        divForm.hidden = true;
    }
    var seleccio = document.getElementById("puntsNous");
    seleccio.innerHTML='';
    var btnMostrarPunts = document.getElementById("boto_mostrarDades");
    btnMostrarPunts.innerHTML="<i class=\"fa fa-eye\"></i> Mostra els punts";
    document.getElementById("bttn_close").innerHTML="<i class=\"fa fa-times\" aria-hidden=\"true\"></i> Tanca selecció de punts";
    document.getElementById("bttn_form_data_local").disabled=false;
}

function checkInputs(){
    $.ajax({
        type: 'GET',
        url : '/v1/geoInfoSystem/comprovarValorsBuitsNouPunt/',
        data:{
            'nomLocal': document.getElementById("nomLocal").value,
            'descripcioLocal': document.getElementById("descripcio").value,
            'superficie': document.getElementById("superficie").value,
            'any': document.getElementById("any").value,
        },
        dataType:'json',
        success:
            function (data){
                if (Object.values(data)[0] ==='true'){
                    checkInputsToProcess();
                }else{
                    if(document.getElementById("errorsBuits").innerHTML === ''){
                        var div=document.getElementById("errorsBuits");
                        div.innerHTML='<i class="fa fa-exclamation-triangle"></i> ';
                        var b=document.createElement("B");
                        var t=document.createTextNode("Siusplau revisa que tots els camps que estiguin plens.");
                        b.appendChild(t);
                        div.appendChild(b);
                        div.hidden=false;
                    }
                }
            }
    });
}

function checkInputsToProcess(){
    $.ajax({
        type: 'GET',
        url : '/v1/geoInfoSystem/comprovarDadesNouPunt/',
        data:{
            'nomLocal': document.getElementById("nomLocal").value,
            'superficie': document.getElementById("superficie").value,
            'any': document.getElementById("any").value,
            'poblacio' : document.getElementById("poblacioG").value,
            'tipus': document.getElementById("categoriaPunt").value
        },
        dataType:'json',
        success:
            function (data){
                if(Object.values(data)[0] === 'true'){
                    guardarSeleccionat();
                }else{
                    document.getElementById("errorsProcessament").hidden = false;
                }
            }
    });
}

function guardarSeleccionat(){
    var llistatPunts=[];
    var input=document.getElementById("puntNou");
    var seleccio = document.getElementById("puntsNous");
    var altresPunts = document.getElementById("altresPunsNous");
    var pAux = document.getElementById("puntAux");
    var midaLlistaPunts = document.getElementById("midaLlistatPunts");
    //console.log(seleccio.childNodes);
    var malament=1;
    seleccio.childNodes.forEach(node => {
        if(node.selected){
            if(node.value == "selectcard"){
                alert('Selecciona un punt pel qual vulguis crear.');
                malament = 0;
            }else{
                input.value = node.text+","+node.value; //nomPunt,lat lng
                pAux.value=node.text; //punt X
            }
        }
	});
    seleccio.childNodes.forEach(node =>{
        if(node.text !== pAux.value){
            llistatPunts.push(node.text+","+node.value);
        }
    });

    midaLlistaPunts.value=llistatTitolsNousMarkers.length.toString();
    var json = JSON.stringify(llistatPunts);
    altresPunts.value = json;
    //console.log(altresPunts.value);
    if(malament===1){
        document.getElementById("form_guardar_nou_punt").submit();
    }
}


function mostrarCoordenades(){
    var div = document.getElementById("nousPunts");
    var seleccio = document.getElementById("puntsNous");
    var btnMostrarPunts = document.getElementById("boto_mostrarDades");
    var p=document.getElementById("InformatiuNoPunts");
    if(llistatNousMarkers.length!== 0){
        //console.log(llistatTitolsNousMarkers);
        p.innerHTML='';
        div.hidden=false;
        if(div.hidden === false){
            seleccio.innerHTML='';
            btnMostrarPunts.innerHTML="<img style='height: 22px' src=\"https://img.icons8.com/ios/64/000000/location-update.png\"/> Actualitza llistat de punts";
        }
        for(var i = 0; i< llistatNousMarkers.length; i++){
            seleccio.innerHTML+=`<option id="`+i+`" value="`+llistatTitolsNousMarkers[i]['pInteres'].getLatLng().lat.toString()+" "+llistatTitolsNousMarkers[i]['pInteres'].getLatLng().lng.toString()+`">`+llistatTitolsNousMarkers[i]['titol']+`</option>`;
        }
        seleccio.innerHTML+=`<option value="selectcard" id="seleccionat" selected>--- Siusplau selecciona un punt ---</option>`;
    }else{
        p.innerHTML = p.innerHTML !== '' ? '' : '<b>No hi ha cap punt marcat en el mapa. Primer marca els punts nous.</b>';
    }
}

function eliminarTotsPuntsInteresNous(){
    var divForm = document.getElementById("dadesSeguents");
    var divTipus = document.getElementById("tipusPunt");
    var divSeleccProv = document.getElementById("selectProvincia");
    var divUbi = document.getElementById("ubicacio");
    var seleccio = document.getElementById("puntsNous");
    seleccio.innerHTML='';
    var div = document.getElementById("nousPunts");
    var btnMostrarPunts = document.getElementById("boto_mostrarDades");
    btnMostrarPunts.innerHTML="<i class=\"fa fa-eye\"></i> Mostra els punts";
    div.hidden=true;
    if (divForm.hidden == false){
        divForm.hidden = true;
    }
    document.getElementById("errorsBuits").hidden = true;
    document.getElementById("errorsProcessament").hidden=true;
    divTipus.innerHTML='';
    divSeleccProv.innerHTML='';
    divUbi.innerHTML='';
    for(var i=0; i< llistatNousMarkers.length; i++){
        mymap.removeLayer(llistatNousMarkers[i]);
    }
    document.getElementById("nomLocal").value='';
    document.getElementById("descripcio").value='';
    document.getElementById("any").value='';
    llistatNousMarkers=[];
    document.getElementById("bttn_form_data_local").disabled=false;
    document.getElementById("bttn_close").innerHTML='<i class="fa fa-times" aria-hidden="true"></i> Tanca selecció de punts';
}

function mostraLesCoordenadesUsuari(){
    if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(centrarMapa);
  } else {
    alert("La geolocalització no és suportada per aquest navegador. No es pot centrar el mapa.");
  }
}

function centrarMapa(position){
    var punt = {
        "lat" : position.coords.latitude,
        "lng" : position.coords.longitude
    };
    mymap.flyTo([punt.lat, punt.lng], 13);
}

function emmagatzemarPuntuacio(puntuacio){
    document.getElementById("puntuacio").value= puntuacio.toString();
}

let starIds=['1', '2', '3', '4', '5'];
starIds.forEach(function(element) {
    document.getElementById(element).addEventListener('click', function(){
        var cls=document.getElementById(element).className;
        if(cls.includes('unchecked'))
        {
            if(element==='5'){
                //hi ha un 5 com a estat de conservacio
                emmagatzemarPuntuacio(5);
                document.getElementById(element).classList.remove('unchecked');
                document.getElementById(element).classList.add('checked');
                document.getElementById('4').classList.remove('unchecked');
                document.getElementById('4').classList.add('checked');
                document.getElementById('3').classList.remove('unchecked');
                document.getElementById('3').classList.add('checked');
                document.getElementById('2').classList.remove('unchecked');
                document.getElementById('2').classList.add('checked');
                document.getElementById('1').classList.remove('unchecked');
                document.getElementById('1').classList.add('checked');
            }else if(element === '4'){
                //hi ha un 4 com a estat de conservacio
                emmagatzemarPuntuacio(4);
                document.getElementById(element).classList.remove('unchecked');
                document.getElementById(element).classList.add('checked');
                document.getElementById('3').classList.remove('unchecked');
                document.getElementById('3').classList.add('checked');
                document.getElementById('2').classList.remove('unchecked');
                document.getElementById('2').classList.add('checked');
                document.getElementById('1').classList.remove('unchecked');
                document.getElementById('1').classList.add('checked');
            }else if (element === '3'){
                //hi ha un 3 com a estat de conservacio
                emmagatzemarPuntuacio(3);
                document.getElementById(element).classList.remove('unchecked');
                document.getElementById(element).classList.add('checked');
                document.getElementById('2').classList.remove('unchecked');
                document.getElementById('2').classList.add('checked');
                document.getElementById('1').classList.remove('unchecked');
                document.getElementById('1').classList.add('checked');
            }else if (element === '2'){
                //hi ha un 2 com a estat de conservacio
                emmagatzemarPuntuacio(2);
                document.getElementById(element).classList.remove('unchecked');
                document.getElementById(element).classList.add('checked');
                document.getElementById('1').classList.remove('unchecked');
                document.getElementById('1').classList.add('checked');
            }else if (element === '1'){
                //hi ha un 1 com a estat de conservacio
                emmagatzemarPuntuacio(1);
                document.getElementById(element).classList.remove('unchecked');
                document.getElementById(element).classList.add('checked');
            }
        }else if(cls.includes('checked')){
            if (element === '5'){
                document.getElementById(element).classList.remove('checked');
                document.getElementById(element).classList.add('unchecked');
                //hi ha un 4 com a estat de conservacio
                emmagatzemarPuntuacio(4);
            }else if (element === '4'){
                document.getElementById(element).classList.remove('checked');
                document.getElementById(element).classList.add('unchecked');
                document.getElementById("5").classList.remove('checked');
                document.getElementById("5").classList.add('unchecked');
                //hi ha un 3 com a estat de conservacio
                emmagatzemarPuntuacio(3);
            }else if (element === '3'){
                document.getElementById(element).classList.remove('checked');
                document.getElementById(element).classList.add('unchecked');
                document.getElementById("4").classList.remove('checked');
                document.getElementById("4").classList.add('unchecked');
                document.getElementById("5").classList.remove('checked');
                document.getElementById("5").classList.add('unchecked');
                //hi ha un 2 com a estat de conservacio
                emmagatzemarPuntuacio(2);
            }else if (element === '2'){
                document.getElementById(element).classList.remove('checked');
                document.getElementById(element).classList.add('unchecked');
                document.getElementById("3").classList.remove('checked');
                document.getElementById("3").classList.add('unchecked');
                document.getElementById("4").classList.remove('checked');
                document.getElementById("4").classList.add('unchecked');
                document.getElementById("5").classList.remove('checked');
                document.getElementById("5").classList.add('unchecked');
                //hi ha un 1 com a estat de conservacio
                emmagatzemarPuntuacio(1);
            }else if (element === '1'){
                document.getElementById(element).classList.remove('checked');
                document.getElementById(element).classList.add('unchecked');
                document.getElementById("2").classList.remove('checked');
                document.getElementById("2").classList.add('unchecked');
                document.getElementById("3").classList.remove('checked');
                document.getElementById("3").classList.add('unchecked');
                document.getElementById("4").classList.remove('checked');
                document.getElementById("4").classList.add('unchecked');
                document.getElementById("5").classList.remove('checked');
                document.getElementById("5").classList.add('unchecked');
                //hi ha un zero com a estat de conservacio
                emmagatzemarPuntuacio(0);
            }
        }
        });
});
</script>

</body>
</html>