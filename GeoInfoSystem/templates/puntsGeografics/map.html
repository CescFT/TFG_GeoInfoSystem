<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mapa</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <style>
        /* Style the header with a grey background and some padding */
    .header {
      overflow: hidden;
      background-color: #f1f1f1;
      padding: 20px 10px;
    }

    /* Style the header links */
    .header a {
      float: left;
      color: black;
      text-align: center;
      padding: 12px;
      text-decoration: none;
      font-size: 18px;
      line-height: 25px;
      border-radius: 4px;
    }

    /* Style the logo link (notice that we set the same value of line-height and font-size to prevent the header to increase when the font gets bigger */
    .header a.logo {
      font-size: 25px;
      font-weight: bold;
    }

    /* Change the background color on mouse-over */
    .header a:hover {
      background-color: #ddd;
      color: black;
    }

    /* Style the active/current link*/
    .header a.active {
      background-color: dodgerblue;
      color: white;
    }

    /* Float the link section to the right */
    .header-right {
      float: right;
    }

    /* Add media queries for responsiveness - when the screen is 500px wide or less, stack the links on top of each other */
    @media screen and (max-width: 500px) {
      .header a {
        float: none;
        display: block;
        text-align: left;
      }
      .header-right {
        float: none;
      }
    }
    #map {
        height: 400px;  /* The height is 400 pixels */
        width: 100%;  /* The width is the width of the web page */
       }



    </style>


</head>
<body onload="iniPagina()">
    <div class="header">
        <a href="/" class="logo">Sistema d'informació Geogràfica</a>
        <div class="header-right">
            <a class="active" href="/">Pàgina d'inici</a>
            {% if user.is_authenticated %}
                <a href="/v1/geoInfoSystem/el_meu_espai/">{{ user.username }}</a>
                <a href="/v1/geoInfoSystem/tancar_sessio/">Tanca la sessió</a>
            {% else %}
                <a href="/v1/geoInfoSystem/registrar_nou_usuari/">Registra't</a>
                <a href="/v1/geoInfoSystem/inicia_sessio/">Inicia sessió</a>
            {% endif %}
        </div>
    </div>



    <div id="map"></div>

    <div id="panellControl">
        <p>En aquest espai podràs filtrar la informació que apareix en el mapa!<br>A continuació veuràs una sèrie de panells i accions que pots dur a terme!</p>

        <div id="filtres">
            <form id="formEstadistiques" method="POST" action="/v1/geoInfoSystem/estadistiques/">
                <p>Provincia:<div id="provincies"></div></p>
                <p>Ciutat:<div id="ubicacio"></div></p>
                <p>Tipus:<div id="tipus"></div></p>
                <p>Actiu: <input type="checkbox" onclick="canviEstat()" name="actiu" id="esActiu"></p>

                <input type="hidden" name="categoria" id="categoriaSeleccionada" value="Restauració">
                <input type="hidden" name="esActiu" id="estat" value="False">
                <input type="hidden" name="poblacio" id="pobleSeleccionat" value="Aiguamúrcia (Alt Camp), Tarragona">
            </form>
                <button onclick="netejarEstadistiques()">Neteja estadístiques</button>
                <button type="submit" onclick="executarForm()"> Veure Estadístiques</button>
        </div>
        <div id="resultatsCerca"></div>
    </div>


<script>
    var map;
// Initialize and add the map
function initMap() {
    //Localitzem en el món Catalunya
    var catalunya = {lat: 41.8204600, lng: 1.8676800};
    // Mapa centrat a Catalunya
    map = new google.maps.Map(document.getElementById('map'), {zoom: 7, center: catalunya});
    // Marquem els punts en el mapa.
    var punts=JSON.parse('{{ puntsInteres | safe }}');
    var locals = JSON.parse(`{{ locals | safe }}`);
    var localitzacions = JSON.parse(`{{ localitzacionsMapa | safe }}`);
    var categories = JSON.parse(`{{ categoriesMapa | safe }}`);

    var posicioPuntInteres;
    var pointsToDo=[];
    var localsToDo=[];
    var localitzacionsToDo = [];
    var categoriesToDo = [];


    for(categoria of categories){
        categoriesToDo.push({
            "pk": categoria.pk,
           "categoria" : categoria.fields.categoria
        });
    }

    //console.log(categoriesToDo);

    for (localitzacio of localitzacions){
        localitzacionsToDo.push({
            "pk" : localitzacio.pk,
            "ciutat" :localitzacio.fields.ciutat,
            "comarca":localitzacio.fields.comarca,
            "provincia":localitzacio.fields.provincia
        });
    }
    console.log(localitzacionsToDo);

    for(local of locals){
        localsToDo.push({
            "localitzacio" : local.fields.localitzacio,
            "nomLocal" : local.fields.nomLocal,
            "puntuacio" : local.fields.estat_conservacio,
            "puntuacioS" : local.fields.estat_conservacio.toString(),
            "categoria" : local.fields.categoria,
            "anyConstruccio" : local.fields.anyConstruccio,
            "anyConstruccioS" : local.fields.anyConstruccio.toString(),
            "descripcio" : local.fields.descripcio
        });
    }
    //console.log(localsToDo);
    for(punt of punts){
        pointsToDo.push({
            "position" : new google.maps.LatLng(punt.fields.latitud, punt.fields.longitud),
            "pk" : punt.pk ,
            "latitud" : punt.fields.latitud,
            "longitud" : punt.fields.longitud,
            "latitudS" : punt.fields.latitud.toString(),
            "longitudS" : punt.fields.longitud.toString(),
            "Superficie" : punt.fields.superficie.toString(),
            "Localitat" : punt.fields.localitat.toString()
        });
    }

    //console.log(pointsToDo);

    for(var i=0; i<pointsToDo.length; i++){
        for(var j=0; j<localsToDo.length; j++){
            if(pointsToDo[i]['pk'] == localsToDo[j]['localitzacio']){
                //console.log(localsToDo[j]['descripcio']);
                let fkLocalitat = pointsToDo[i]['Localitat'];
                let ciutat = localitzacionsToDo.find(x => x.pk == fkLocalitat).ciutat;
                let comarca = localitzacionsToDo.find(x => x.pk == fkLocalitat).comarca;
                let provincia = localitzacionsToDo.find(x => x.pk == fkLocalitat).provincia;
                let fkCategoria = localsToDo[j]['categoria'];
                let categoria = categoriesToDo.find(x => x.pk == fkCategoria).categoria;
                var string ="";
                    string+="<div><br>";
                    string+="<table>";
                    string +="<thread><tr><th><b>INFORMACIÓ D'INTERÈS:</b></th></tr></thread>";
                    string +="<tr><td><b>- Coordenades:</b></td> <td>("+pointsToDo[i]['latitudS']+","+ pointsToDo[i]['longitudS']+")</td></tr>";
                    string +="<tr><td><b>- Superficie:</b></td> <td> "+pointsToDo[i]['Superficie']+"</td></tr>";
                    string +="<tr><td><b>- Categoria:</b></td> <td> "+categoria+"</td></tr>";
                    string +="<tr><td><b>- Any Construcció:</b></td> <td> "+localsToDo[j]['anyConstruccioS']+"</td></tr>";
                    string +="<tr><td><b>- Localitat:</b></td> <td> "+ciutat+" ("+comarca+"), "+provincia+", Catalunya</td></tr>";
                    string += "</table>";
                    string+="</div>";
                var url = "localhost:8000/v1/geoInfoSystem/info_especifica/"+localsToDo[j]['nomLocal']+"/"+pointsToDo[i]['latitud']+"/"+pointsToDo[i]['longitud']+"/";
                url = encodeURI(url);

            let contentString = '<div id="content">'+
            '<div id="siteNotice">'+
            '</div>'+
            '<h1 id="firstHeading" class="firstHeading">'+localsToDo[j]['nomLocal']+'</h1>'+
            '<div id="bodyContent">'+
            '<table><tr><p><b>'+localsToDo[j]['nomLocal']+'</b><tr>'+localsToDo[j]['descripcio']+'</p></tr></tr></table>'+
            string+
             '<a target="_blank" rel="noopener noreferrer" href='+url+'>Click aquí per a més informació</a>'+
            '</div>'+
            '</div>';

            let infowindow= new google.maps.InfoWindow({
                content: contentString
            });
           let marker = new google.maps.Marker({position: pointsToDo[i]['position'], map: map, title:localsToDo[j]['nomLocal']});
            marker.addListener('click', function () {
                infowindow.open(map, marker);
            });
        }
    }
    }
}

        function executarForm(){
            document.getElementById("formEstadistiques").submit();
        }
        function canviEstat(){
            var inputhidden = document.getElementById("estat");
            if (inputhidden.value == 'False'){
                inputhidden.value = 'True';
            }else inputhidden.value = 'False';
            //TODO ajax
            $.ajax({
                        type: 'GET',
                        url : '/v1/geoInfoSystem/estadistiques/',
                        data:{
                            'poblacio' : document.getElementById('pobleSeleccionat').value,
                            'actiu' : inputhidden.value,
                            'categoria' : document.getElementById("categoriaSeleccionada").value
                        },
                        dataType:'json',
                        success:
                            function (data){
                                var data1 = Object.values(data);
                                console.log(data1);
                            }
                    });
        }
        function guardarTipus(){
            var inputhidden = document.getElementById("categoriaSeleccionada");
            var elem = document.getElementById("tipusSeleccio");
            elem.childNodes.forEach(node => {
                if(node.selected){
                    //console.log(node.value);
                    inputhidden.value = node.value;
                    //TODO ajax
                    $.ajax({
                        type: 'GET',
                        url : '/v1/geoInfoSystem/estadistiques/',
                        data:{
                            'poblacio' : document.getElementById('pobleSeleccionat').value,
                            'actiu' : document.getElementById('estat').value,
                            'categoria' : inputhidden.value
                        },
                        dataType:'json',
                        success:
                            function (data){
                                var data1 = Object.values(data);
                                console.log(data1);
                            }
                    });
                }
            });
        }

        function iniPagina(){
            var divpobles = document.getElementById("ubicacio");
            var divtipus =document.getElementById("tipus");
            var poblesTGN = JSON.parse(`{{poblesTGN | safe}}`);
            var totescategories = JSON.parse(`{{totesCategories | safe}}`);
            var divProvincies = document.getElementById("provincies");
            var provincies =JSON.parse(`{{ provincies | safe }}`);
            var llProvincies = Object.values(provincies);
            var llPoblesTGN = Object.values(poblesTGN);
            var categoriesToDo = [];
            for(categoria of totescategories)
            {
                categoriesToDo.push({
                    "categoria" : categoria.fields.categoria
                });
            }

            //console.log(llPoblesTGN);
            var sPoble = document.createElement("SELECT");
            sPoble.setAttribute("id", "poblacioSeleccio");
            sPoble.setAttribute("onchange", "guardarPoblacio()");
            divpobles.appendChild(sPoble);
            for(var j=0; j<llPoblesTGN.length; j++){
                let option = document.createElement("option");
                option.setAttribute("value", llPoblesTGN[j]);
                let t = document.createTextNode(llPoblesTGN[j]);
                option.appendChild(t);
                document.getElementById("poblacioSeleccio").appendChild(option);
            }

            var sCategoria = document.createElement("SELECT");
            sCategoria.setAttribute("id", "tipusSeleccio");
            sCategoria.setAttribute("onchange", "guardarTipus()");
            divtipus.appendChild(sCategoria);
            for(var i=0; i<categoriesToDo.length; i++){
                let option = document.createElement("option");
                option.setAttribute("value", categoriesToDo[i]['categoria']);
                let t = document.createTextNode(categoriesToDo[i]['categoria']);
                option.appendChild(t);
                document.getElementById("tipusSeleccio").appendChild(option);
            }
            var sProvincia = document.createElement("SELECT");
            sProvincia.setAttribute("id", "provinciaSeleccio");
            sProvincia.setAttribute("onchange", "poblacionsPerProvincia()");
            divProvincies.appendChild(sProvincia);
            for(var k=0; k<llProvincies.length; k++){
                let option = document.createElement("option");
                option.setAttribute("value", llProvincies[k]);
                let t = document.createTextNode(llProvincies[k]);
                option.appendChild(t);
                document.getElementById("provinciaSeleccio").appendChild(option);
            }
        }

        function guardarPoblacio(){
            var inputOcult = document.getElementById("pobleSeleccionat");
            var elem = document.getElementById("poblacioSeleccio");
            var actiu = document.getElementById("estat");
            var categoria =document.getElementById("categoriaSeleccionada");
            elem.childNodes.forEach(node => {
                if(node.selected){
                    //console.log(node.value);
                    inputOcult.value = node.value;
                    var poble=node.value;
                    $.ajax({
                        type: 'GET',
                        url : '/v1/geoInfoSystem/estadistiques/',
                        data:{
                            'poblacio' : poble,
                            'actiu' : actiu.value,
                            'categoria' : categoria.value
                        },
                        dataType:'json',
                        success:
                            function (data){
                                var data1 = Object.values(data);
                                console.log(data1);
                            }
                    });
                }
            });
        }

        function poblacionsPerProvincia(){
            var elem = document.getElementById("provinciaSeleccio");
            var inputOcult = document.getElementById("pobleSeleccionat");
            elem.childNodes.forEach(node => {
              if(node.selected){
                    var defecte=node.value;
                    $.ajax({
                        type: 'GET',
                        url : '/v1/geoInfoSystem/poblacions_per_provincia/',
                        data:{
                            'provincia' : defecte
                        },
                        dataType:'json',
                        success:
                            function (data){
                                var data1 = Object.values(data);
                                var pobles = Object.values(data1[0]);
                                var divpoble = document.getElementById("ubicacio");
                                divpoble.innerHTML="";
                                //console.log(pobles);
                                var sPoble = document.createElement("SELECT");
                                sPoble.setAttribute("id", "poblacioSeleccio");
                                sPoble.setAttribute("onchange", "guardarPoblacio()");
                                divpoble.appendChild(sPoble);
                                for(var j=0; j<pobles.length; j++){
                                    let option = document.createElement("option");
                                    option.setAttribute("value", pobles[j]+", "+defecte);
                                    let t = document.createTextNode(pobles[j]+", "+defecte);
                                    option.appendChild(t);
                                    document.getElementById("poblacioSeleccio").appendChild(option);
                                }
                                inputOcult.value = pobles[0]+", "+defecte;
                            }
                    });
              }
            });

        }
        function netejarEstadistiques(){

        }
    </script>
    <!--Load the API from the specified URL
    * The async attribute allows the browser to render the page while the API loads
    * The key parameter will contain your own API key (which is not needed for this tutorial)
    * The callback parameter executes the initMap() function
    -->
    <script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZYY_D7EaLWIBwLuuXQOM2PSpsTD-5kMs&callback=initMap">
</script>


</body>
</html>